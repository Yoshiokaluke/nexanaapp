# NexanaApp プロジェクト仕様書

## 目次
1. [開発環境](#開発環境)
2. [認証と権限](#認証と権限)
3. [アプリケーション構成](#アプリケーション構成)
4. [データベース設計](#データベース設計)

## 開発環境

### 技術スタック
- フレームワーク: Next.js
- 認証: Clerk (https://clerk.com/)
- データベース: 
  - Neon (https://neon.tech/)
  - Prisma (https://www.prisma.io/)
- デプロイ: Vercel
- ソース管理: GitHub

### 開発ルール
- 最新の安定バージョンを使用すること
- バージョンは存在しないものを利用しないこと

## 認証と権限

### 権限レベル
1. system-team: システム全体の管理者
2. admin: 組織の管理者
3. member: 組織の一般メンバー

### 認証フロー
1. Clerkによる認証（Google認証またはメールアドレス・パスワード）
2. ログイン後、所属organization一覧表示
3. 権限に応じたページアクセス制御
   - system-team: すべてのページにアクセス可能
   - admin: 組織管理機能 + member機能にアクセス可能
   - member: 一般機能のみアクセス可能

### QRスキャナー認証
- 専用のIDとパスワードによるログイン
- 組織紐付けによるアクセス制御
- system-team権限者による管理

## アプリケーション構成

詳細な構成については[ディレクトリ構造](./ディレクトリ案.md)を参照

### 主要機能
1. ユーザー管理
2. 組織管理
3. イベント管理
4. QRコード管理
5. スキャナー管理

## データベース設計

詳細なスキーマについては`prisma/schema.prisma`を参照

### 主要モデル
1. User（ユーザー情報）
2. Organization（組織情報）
3. OrganizationMembership（組織メンバーシップ）
4. OrganizationProfile（組織プロフィール）
5. QrScanner（QRスキャナー）
6. Event（イベント）
7. DrinkTicket（ドリンクチケット）

## 実装フェーズ

### Phase 1: 認証・権限システム
1. **Clerk認証基盤**
   - Google認証連携
   - メールアドレス・パスワード認証
   - ミドルウェアの設定

2. **権限管理システム**
   - システムロール（system-team）
   - 組織ロール（admin, member）
   - アクセス制御の実装

3. **QRスキャナー認証**
   - スキャナー固有の認証システム
   - 組織との紐付け
   - セキュリティ対策

### Phase 2: プロフィール管理
1. **共通プロフィール**
   - 基本情報（name, email, gender, birthDate）
   - システムロール管理
   - 通知設定

2. **組織プロフィール**
   - 組織固有の表示名
   - 所属情報
   - カスタムフィールド

3. **設定画面**
   - プロフィール編集
   - 権限表示
   - 組織切り替え

### Phase 3: 組織管理
1. **組織基本機能**
   - 組織作成・編集
   - メンバー招待
   - 基本設定

2. **メンバー管理**
   - 権限設定
   - メンバーリスト
   - プロフィール管理

3. **管理機能**
   - 組織設定
   - アクセス管理
   - ログ管理

### 検討事項
1. **Phase 1 (認証・権限)**
   - [ ] Clerkの具体的な設定値
   - [ ] 権限の継承ルール
   - [ ] セッション管理方式

2. **Phase 2 (プロフィール)**
   - [ ] プロフィール項目の詳細定義
   - [ ] バリデーションルール
   - [ ] 画像アップロード方式

3. **Phase 3 (組織管理)**
   - [ ] 組織の階層構造
   - [ ] メンバー招待フロー
   - [ ] 権限変更の承認フロー

## 解析中の疑問点・不明点

1. **プロフィール設定の整理**
   - 共通プロフィールと組織固有プロフィールの境界が不明確
   - プロフィール項目の重複可能性

2. **イベント機能の詳細**
   - イベント参加者の権限設定
   - イベントの可視性範囲

3. **QRコードの有効期限**
   - 通常QRコードの有効期限設定
   - ゲストQRコードの有効期限ルール

4. **ドリンクチケットの仕様**
   - チケットの譲渡可否
   - 複数チケットの一括使用可否

5. **スキャナーの運用**
   - オフライン対応の要否
   - エラー時のリカバリー方法

これらの点について、追加の情報や確認が必要と考えています。 